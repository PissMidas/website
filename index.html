<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>PissMidas - Awakening Overlay Uploader</title>
<meta name="google-site-verification" content="quPe9cKBc7hcUIQpqAdgw34o3To2IaBWSDzcB1SZ-44" />
<style>
  body { font-family: Arial, sans-serif; max-width:700px; margin:2rem auto; line-height:1.6; }
  button { margin-top:20px; padding:10px 20px; font-size:16px; cursor:pointer; }
  #selected-spreadsheet { margin-top:20px; font-weight:bold; word-break:break-word; }
  #status { margin-top:10px; color:#555; }
</style>
</head>
<body>
  <h1>PissMidas</h1>
  <p>Awakening Overlay Uploader — select a Google Spreadsheet. Firefox requires a direct user gesture for popups; this page uses a safe multi-click flow.</p>

  <button id="pick-spreadsheet-btn" disabled>Authenticate</button>
  <div id="status">Loading APIs...</div>
  <div id="selected-spreadsheet"></div>

  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>

  <script>
  // ---------- CONFIG ----------
  const CLIENT_ID = '304904465571-jt6kkpt4hcf1961khu78l4fud89u5im8.apps.googleusercontent.com';
  const DEVELOPER_KEY = 'AIzaSyDOdsegG1Z1AyXM_hSwX3LapVFwp2xOiYM';
  const APP_ID = '304904465571';
  const SCOPES = 'https://www.googleapis.com/auth/drive.file';

  // ---------- STATE ----------
  let tokenClient = null;
  let accessToken = null;
  let pickerInited = false;
  let gisInited = false;
  let step = 0; // 0 = ready to Authenticate, 1 = auth requested, 2 = auth confirmed (ready to pick)

  const statusEl = document.getElementById('status');
  const pickBtn = document.getElementById('pick-spreadsheet-btn');
  const selectedEl = document.getElementById('selected-spreadsheet');

  // ---------- API load handlers ----------
  function gapiLoaded() {
    gapi.load('picker', () => { pickerInited = true; updateUi(); });
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (resp) => {
        if (resp.error) {
          console.error('Token error', resp);
          statusEl.textContent = 'Authentication error. Click Authenticate to try again.';
          // keep step as-is so user can retry
          return;
        }
        accessToken = resp.access_token;
        // IMPORTANT: do not open Picker here. Only update state/UI.
        statusEl.textContent = 'Authentication completed. Click Confirm Authentication to continue.';
        pickBtn.textContent = 'Confirm Authentication';
      }
    });
    gisInited = true;
    updateUi();
  }

  // ---------- UI state ----------
  function updateUi() {
    if (!pickerInited || !gisInited) {
      statusEl.textContent = 'Loading APIs...';
      pickBtn.disabled = true;
      pickBtn.textContent = 'Loading…';
      return;
    }
    // APIs ready
    if (step === 0) {
      pickBtn.disabled = false;
      pickBtn.textContent = 'Authenticate';
      statusEl.textContent = 'APIs loaded. Click Authenticate to sign in.';
    } else if (step === 1) {
      pickBtn.disabled = false;
      pickBtn.textContent = 'Confirm Authentication';
      statusEl.textContent = 'Authentication started. Complete Google sign-in popup, then click Confirm Authentication.';
    } else if (step === 2) {
      pickBtn.disabled = false;
      pickBtn.textContent = 'Choose Spreadsheet';
      statusEl.textContent = 'Authenticated. Click Choose Spreadsheet to open the picker.';
    }
  }

  // ---------- Button flow (multi-click) ----------
  pickBtn.addEventListener('click', () => {
    if (step === 0) {
      // 1st click: request access token (user gesture)
      try {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      } catch (err) {
        console.error('requestAccessToken error', err);
        statusEl.textContent = 'Unable to start auth. Try again.';
        return;
      }
      step = 1;
      updateUi();
      // The token callback will set accessToken asynchronously.
    } else if (step === 1) {
      // 2nd click: confirm that auth completed (user gesture)
      if (!accessToken) {
        statusEl.textContent = 'Still signing in — finish the Google popup, then click Confirm Authentication.';
        return;
      }
      step = 2;
      updateUi();
    } else if (step === 2) {
      // 3rd click: open Picker directly from user gesture
      if (!accessToken) {
        statusEl.textContent = 'No access token present. Click Authenticate to start again.';
        step = 0;
        updateUi();
        return;
      }
      createPicker();
    }
  });

  // ---------- Create and show Google Picker ----------
  function createPicker() {
    if (!pickerInited) {
      statusEl.textContent = 'Picker not loaded.';
      return;
    }
    const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
    const picker = new google.picker.PickerBuilder()
      .addView(view)
      .enableFeature(google.picker.Feature.NAV_HIDDEN)
      .setOAuthToken(accessToken)
      .setDeveloperKey(DEVELOPER_KEY)
      .setAppId(APP_ID)
      .setCallback(pickerCallback)
      .build();
    picker.setVisible(true);
    statusEl.textContent = 'Picker opened. Choose a spreadsheet.';
  }

  // ---------- Picker callback ----------
  function pickerCallback(data) {
    if (data.action === google.picker.Action.PICKED) {
      const doc = data.docs[0];
      const fileId = doc.id;
      const fileUrl = `https://docs.google.com/spreadsheets/d/${fileId}/edit`;
      selectedEl.innerHTML = `Selected Spreadsheet: <a href="${fileUrl}" target="_blank" rel="noopener noreferrer">${fileUrl}</a>`;
      statusEl.textContent = 'Spreadsheet selected successfully.';
      // reset flow so user can choose another later
      step = 0;
      accessToken = accessToken; // keep token cached if desired
      updateUi();
    } else if (data.action === google.picker.Action.CANCEL) {
      statusEl.textContent = 'Spreadsheet selection cancelled.';
      // keep at step 2 so user can open picker again
      updateUi();
    }
  }

  // ---------- On load ----------
  window.addEventListener('load', () => {
    pickBtn.disabled = true;
    updateUi();
  });
  </script>
</body>
</html>
