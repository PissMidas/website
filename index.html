<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PissMidas - Awakening Overlay Uploader</title>
<style>
body { font-family: Arial, sans-serif; max-width: 700px; margin: 2rem auto; line-height: 1.6; }
button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
#status { margin-top: 10px; color: #555; }
#selected-spreadsheet { margin-top: 20px; font-weight: bold; word-break: break-word; }
</style>
</head>
<body>
<h1>PissMidas</h1>
<p>Official homepage of the Awakening Overlay Uploader App.</p>

<button id="pick-spreadsheet-btn" disabled>Authenticate & Choose Spreadsheet</button>
<div id="status">Loading APIs...</div>
<div id="selected-spreadsheet"></div>

<!-- Load Google API scripts synchronously -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
const CLIENT_ID = '304904465571-jt6kkpt4hcf1961khu78l4fud89u5im8.apps.googleusercontent.com';
const DEVELOPER_KEY = 'AIzaSyDOdsegG1Z1AyXM_hSwX3LapVFwp2xOiYM';
const APP_ID = '304904465571';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient;
let accessToken = null;
let pickerInited = false;
let gisInited = false;

const pickBtn = document.getElementById('pick-spreadsheet-btn');
const statusEl = document.getElementById('status');
const selectedEl = document.getElementById('selected-spreadsheet');

// Initialize Picker API
function gapiLoaded() {
    gapi.load('picker', () => {
        pickerInited = true;
        updateStatus();
    });
}

// Initialize Google Identity Services
function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
            if (resp.error) {
                statusEl.textContent = 'Authentication failed';
                console.error(resp);
                return;
            }
            accessToken = resp.access_token;
            statusEl.textContent = 'Authentication successful. Click the button again to open Picker.';
            pickBtn.textContent = 'Open Spreadsheet Picker';
            pickBtn.disabled = false;
        }
    });
    gisInited = true;
    updateStatus();
}

// Update button and status
function updateStatus() {
    if (!pickerInited || !gisInited) {
        statusEl.textContent = 'Loading Google APIs...';
        pickBtn.disabled = true;
        return;
    }
    pickBtn.disabled = false;
    statusEl.textContent = accessToken ? 'Click to open Picker' : 'Click to authenticate';
}

// Handle button clicks (two-step flow)
pickBtn.addEventListener('click', () => {
    if (!accessToken) {
        // Step 1 click: request OAuth token
        tokenClient.requestAccessToken({ prompt: 'consent' });
        statusEl.textContent = 'OAuth popup opened, please authenticate and click again to pick spreadsheet';
    } else {
        // Step 2 click: open Picker directly from user click
        createPicker();
    }
});

// Open Google Picker
function createPicker() {
    if (!pickerInited) {
        alert('Picker API not loaded yet.');
        return;
    }
    const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
    const picker = new google.picker.PickerBuilder()
        .addView(view)
        .enableFeature(google.picker.Feature.NAV_HIDDEN)
        .setOAuthToken(accessToken)
        .setDeveloperKey(DEVELOPER_KEY)
        .setAppId(APP_ID)
        .setCallback(pickerCallback)
        .build();
    picker.setVisible(true);
}

// Handle selection
function pickerCallback(data) {
    if (data.action === google.picker.Action.PICKED) {
        const doc = data.docs[0];
        const fileUrl = `https://docs.google.com/spreadsheets/d/${doc.id}/edit`;
        selectedEl.innerHTML = `Selected Spreadsheet: <a href="${fileUrl}" target="_blank">${fileUrl}</a>`;
        statusEl.textContent = 'Spreadsheet selected successfully.';
    } else if (data.action === google.picker.Action.CANCEL) {
        statusEl.textContent = 'Spreadsheet selection cancelled.';
    }
}

// Initialize APIs on page load
gapiLoaded();
gisLoaded();
</script>
</body>
</html>
