<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PissMidas - Overlay Uploader (Firefox-safe)</title>
<style>
body { font-family: Arial, sans-serif; max-width: 700px; margin: 2rem auto; line-height: 1.6; }
button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
#status { margin-top: 10px; color: #555; }
#selected-spreadsheet { margin-top: 20px; font-weight: bold; word-break: break-word; }
</style>
</head>
<body>
<h1>PissMidas</h1>
<p>Official homepage of the Awakening Overlay Uploader App.</p>

<button id="pick-spreadsheet-btn" disabled>Authenticate & Choose Spreadsheet</button>
<div id="status">Loading APIs...</div>
<div id="selected-spreadsheet"></div>

<!-- Load Google API scripts synchronously to ensure gapi exists -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
const CLIENT_ID = '304904465571-jt6kkpt4hcf1961khu78l4fud89u5im8.apps.googleusercontent.com';
const DEVELOPER_KEY = 'AIzaSyDOdsegG1Z1AyXM_hSwX3LapVFwp2xOiYM';
const APP_ID = '304904465571';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient;
let accessToken = null;
let pickerInited = false;
let gisInited = false;

const pickBtn = document.getElementById('pick-spreadsheet-btn');
const statusEl = document.getElementById('status');
const selectedEl = document.getElementById('selected-spreadsheet');

// Initialize Picker API
function gapiLoaded() {
    gapi.load('picker', () => {
        pickerInited = true;
        updateStatus();
    });
}

// Initialize Google Identity Services
function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
            if (resp.error) {
                statusEl.textContent = 'Authentication failed';
                console.error(resp);
                return;
            }
            accessToken = resp.access_token;
            statusEl.textContent = 'Authenticated. Click the button to open Picker.';
            pickBtn.disabled = false;
        }
    });
    gisInited = true;
    updateStatus();
}

// Update button and status
function updateStatus() {
    if (!pickerInited || !gisInited) {
        statusEl.textContent = 'Loading Google APIs...';
        pickBtn.disabled = true;
        return;
    }
    pickBtn.disabled = false;
    statusEl.textContent = accessToken ? 'Click to open Picker' : 'Click to authenticate';
}

// Handle button clicks
pickBtn.addEventListener('click', () => {
    if (!accessToken) {
        // First click: request OAuth token
        tokenClient.requestAccessToken({ prompt: 'consent' });
        return;
    }

    // Open popup for Picker (Firefox-safe)
    const width = 600, height = 500;
    const left = (screen.width / 2) - (width / 2);
    const top = (screen.height / 2) - (height / 2);
    const pickerWindow = window.open('', 'pickerWindow', `width=${width},height=${height},top=${top},left=${left}`);

    pickerWindow.document.write(
        '<!DOCTYPE html><html><head><title>Spreadsheet Picker</title></head><body>' +
        '<div id="status">Loading Picker...</div>' +
        '<script src="https://apis.google.com/js/api.js"><\/script>' +
        '<script>' +
        'const accessToken="' + accessToken + '";' +
        'const DEVELOPER_KEY="' + DEVELOPER_KEY + '";' +
        'const APP_ID="' + APP_ID + '";' +
        'function initPicker() {' +
        '  const view=new google.picker.View(google.picker.ViewId.SPREADSHEETS);' +
        '  const picker=new google.picker.PickerBuilder()' +
        '    .addView(view)' +
        '    .setOAuthToken(accessToken)' +
        '    .setDeveloperKey(DEVELOPER_KEY)' +
        '    .setAppId(APP_ID)' +
        '    .setCallback((data)=>{' +
        '      if(data.action===google.picker.Action.PICKED){' +
        '        const doc=data.docs[0];' +
        '        window.opener.postMessage({ spreadsheetUrl:"https://docs.google.com/spreadsheets/d/"+doc.id+"/edit" },"*");' +
        '        window.close();' +
        '      } else if(data.action===google.picker.Action.CANCEL){ window.close(); }' +
        '    })' +
        '    .build();' +
        '  picker.setVisible(true);' +
        '}' +
        'gapi.load("picker", initPicker);' +
        '<\/script></body></html>'
    );
});

// Receive spreadsheet selection from popup
window.addEventListener('message', (e) => {
    if (e.data && e.data.spreadsheetUrl) {
        selectedEl.innerHTML = 'Selected Spreadsheet: <a href="' + e.data.spreadsheetUrl + '" target="_blank">' + e.data.spreadsheetUrl + '</a>';
        statusEl.textContent = 'Spreadsheet selected successfully.';
    }
});

// Initialize after page load
gapiLoaded();
gisLoaded();
</script>
</body>
</html>
