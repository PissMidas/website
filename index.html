<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PissMidas - Awakening Overlay Uploader</title>
    <meta name="google-site-verification" content="quPe9cKBc7hcUIQpqAdgw34o3To2IaBWSDzcB1SZ-44" />
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 2rem auto;
            line-height: 1.6;
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #selected-spreadsheet {
            margin-top: 20px;
            font-weight: bold;
            word-break: break-word;
        }
        #status {
            margin-top: 10px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>PissMidas 223</h1>
    <p>This is the official homepage of the Awakening Overlay Uploader App.</p>
    <p>This app is for tournament stream runners to display awakenings for the game Omega Strikers. The app reads data from locally generated .log files that the game creates while running. The app processes those game events and uploads that data to a Google Sheet. Users can then use the sheet to generate a graphic overlay, and have that overlay be broadcasted on their tournament stream.</p>

    <a href="privacy.html">Privacy Policy</a>

    <h2>Select a Google Spreadsheet</h2>
    <p>Click the button below to give the app permission to use a chosen spreadsheet. This step is required to get the app to read your spreadsheet.</p>
    <button id="pick-spreadsheet-btn" disabled>Choose Spreadsheet</button>

    <div id="status">Loading APIs...</div>
    <div id="selected-spreadsheet"></div>

    <!-- Load Google APIs with onload callbacks -->
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js?onload=loadPickerApi"></script>
    <script src="https://apis.google.com/js/client.js"></script>

    <script>
        const CLIENT_ID = '304904465571-jt6kkpt4hcf1961khu78l4fud89u5im8.apps.googleusercontent.com';
        const DEVELOPER_KEY = 'AIzaSyDOdsegG1Z1AyXM_hSwX3LapVFwp2xOiYM';
        //const SCOPE = 'https://www.googleapis.com/auth/drive.file';
        const SCOPE = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email openid';

        let tokenClient;
        let accessToken = null;
        let pickerInited = false;
        let gisInited = false;

        const statusEl = document.getElementById('status');
        const pickBtn = document.getElementById('pick-spreadsheet-btn');
        const selectedSpreadsheetEl = document.getElementById('selected-spreadsheet');

        // Called when the Google Picker API is loaded
        function gapiLoaded() {
            console.log("Google API loaded.");
            gapi.load('picker', {
                callback: () => {
                    pickerInited = true;
                    console.log("Picker API initialized.");
                    updateStatus();
                }
            });
        }

        // Called when Google Identity Services client is loaded
        function gisLoaded() {
            console.log("Google Identity Services client loaded.");
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPE,
                callback: (resp) => {
                    if (resp.error) {
                        console.error('Token error:', resp);
                        statusEl.textContent = 'Authentication failed. Please try again.';
                        return;
                    }
                    accessToken = resp.access_token;
                    console.log('Access token obtained.');
                    statusEl.textContent = 'Authentication successful. You can now choose a spreadsheet.';
                    pickBtn.disabled = false;
                    loadPicker();
                }
            });
            gisInited = true;
            updateStatus();
        }

        // Update UI status text depending on what is ready
        function updateStatus() {
            if (!pickerInited && !gisInited) {
                statusEl.textContent = 'Loading APIs...';
                pickBtn.disabled = true;
            } else if (!pickerInited) {
                statusEl.textContent = 'Loading Picker API...';
                pickBtn.disabled = true;
            } else if (!gisInited) {
                statusEl.textContent = 'Loading Identity Services...';
                pickBtn.disabled = true;
            } else {
                statusEl.textContent = 'APIs loaded. Please authenticate to continue.';
                pickBtn.disabled = false;
            }
        }

        // Authenticate and request access token
        function authenticate() {
            return new Promise((resolve, reject) => {
                if (!accessToken) {
                    statusEl.textContent = 'Requesting authorization...';
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                    resolve();
                } else {
                    resolve();
                }
            });
        }

        // Load the Google Picker to select spreadsheets
        function loadPicker() {
            if (!pickerInited || !accessToken) {
                alert("Picker API or authorization not ready yet.");
                return;
            }

            const view = new google.picker.View(google.picker.ViewId.SPREADSHEETS);
            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .setDeveloperKey(DEVELOPER_KEY)
                .setOAuthToken(accessToken)
                .addView(view)
                .setCallback(pickerCallback)
                .build();
            picker.setVisible(true);
            console.log("Picker displayed.");
        }

        // Callback for when a user picks a spreadsheet
        function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const fileId = data.docs[0].id;
                const fileUrl = `https://docs.google.com/spreadsheets/d/${fileId}/edit`;
                console.log(`User selected spreadsheet: ${fileUrl}`);
                selectedSpreadsheetEl.innerHTML = `Selected Spreadsheet: <a href="${fileUrl}" target="_blank" rel="noopener noreferrer">${fileUrl}</a>`;
                statusEl.textContent = 'Spreadsheet selected successfully.';
                // TODO: Pass fileId to your backend or store as needed
            } else if (data.action === google.picker.Action.CANCEL) {
                statusEl.textContent = 'Spreadsheet selection cancelled.';
            }
        }

        // Event listener for the button
        pickBtn.addEventListener('click', () => {
            authenticate();
        });

        // On page load, disable the button until APIs are ready
        window.onload = () => {
            pickBtn.disabled = true;
            updateStatus();
        };
    </script>
</body>
</html>
